version: '3.8'
services:
  kestra:
    image: kestra/kestra:latest
    pull_policy: always
    command: /app/kestra server standalone --worker-thread=128
    environment:
      # Required Kestra configuration properties
      KESTRA_REPOSITORY_TYPE: postgres
      KESTRA_STORAGE_TYPE: local
      KESTRA_QUEUE_TYPE: postgres
      KESTRA_SERVER_BASIC_AUTH_ENABLED: true
      KESTRA_SERVER_BASIC_AUTH_USERNAME: ${KESTRA_USERNAME:-admin@kestra.io}
      KESTRA_SERVER_BASIC_AUTH_PASSWORD: ${KESTRA_PASSWORD:-Kestra123}
      KESTRA_URL: ${KESTRA_URL:-http://localhost:8080}
      KESTRA_STORAGE_LOCAL_BASE_PATH: /app/storage

      # PostgreSQL configuration
      KESTRA_DATASOURCE_URL: ${DATABASE_URL:-jdbc:postgresql://localhost:5432/kestra}
      KESTRA_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
    volumes:
      - kestra-data:/app/storage
      - /tmp/kestra-wd:/tmp/kestra-wd
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  kestra-data:
